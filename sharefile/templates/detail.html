

{% extends "base.html" %}
{% load static %}
{% block contents %}

      <div class="album py-5 bg-light">
        <div class="container">
          <div class="card" style="width: 18rem;">
          <div class="card-body">
            <h5 class="card-title"> {{ file.name }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ file.expiration_date }}</h6>
            <p class="card-text">{{ file.description }}</p>
            <a href="{% url 'download' file_id=file.id %}" class="card-link">Download file</a>
            <a href="{% url 'share' file_id=file.id  %}"> <button type="button" class="btn btn-sm btn-outline-secondary">Share</button></a>
          </div>
        </div>
           <div class="row bootstrap snippets">
              <div class="col-md-6 col-md-offset-2 col-sm-12">
                  <div class="comment-wrapper">
                      <div class="panel panel-info">
                          <div class="panel-heading">
                            
                          </div>
                          <div class="panel-body">
                               {% if is_commentable %}
                              <input class="form-control" type="text"  id="comment-input" placeholder="write a comment..." rows="3"></input>
                              <br>
                              <button type="button"  id="comment-submit" class="btn btn-info pull-right">Post</button>
                              <div class="clearfix"></div>
                              <hr>
                           
                              <ul id ="comments-li" class="media-list">


                                   {% for comment in comments %}
                                  <li class="media">
                                      
                                      <div class="media-body">
                                          <span class="text-muted pull-right">
                                              <small class="text-muted">30 min ago</small>
                                          </span>
                                          <strong class="text-success">{{ comment.author }}</strong>
                                          <p>
                                             {{comment.text}}
                                          </p>
                                          {% if comment.author.name == user %}
                                          <a href="#">Edit</a> <a href="#">Delete</a>
                                          {% endif %}
                                      </div>
                                  </li>
                           {% endfor %}
                              </ul>
                              {% endif %}
                          </div>
                      </div>
                  </div>

              </div>
        </div>
      </div>
    <script>
    var roomName = "{{ file.id |escapejs }}";
    console.log(roomName);
    var current_username = "{{ user }}"
    console.log(current_username);

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['comment_text'];
        var username = data['username'];

        console.log(data);
        var div = document.getElementById('comments-li');
        if (current_username==username){
           div.innerHTML += ' <li class="media"><div class="media-body"><span class="text-muted pull-right"><small class="text-muted">30 min ago</small></span><strong class="text-success"> '+ username +'</strong><p> '+  message +' </p> <a href="#">Edit</a> <a href="#">Delete</a></div></li> ';
        }
       
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#comment-input').focus();
    document.querySelector('#comment-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#comment-submit').click();
        }
    };

    document.querySelector('#comment-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#comment-input');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'text': message,
            'file_id' : roomName
        }));

        messageInputDom.value = '';
    };
</script>

{% endblock %}